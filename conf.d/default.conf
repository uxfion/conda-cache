proxy_cache_path /var/cache/nginx/conda 
    levels=2:2 
    keys_zone=conda:1024m  # 修改为 1024m 而不是 1g
    max_size=10995116277760  # 10t 
    use_temp_path=off;

resolver 8.8.8.8 ipv6=off valid=300s;
resolver_timeout 5s;


# Define log format for cache status
log_format cache_status '$remote_addr [$time_local] "$request" $status'
    ' $body_bytes_sent $request_time "$upstream_cache_status"'
    ' "$http_user_agent"';

log_format cache_brief '[$time_local] $remote_addr | $upstream_cache_status | $request_time ms | $body_bytes_sent | $request';

server {
    listen 80;
    server_name repo.anaconda.com;
    access_log /var/log/nginx/conda_access.log cache_status;
    access_log /var/log/nginx/conda_cache.log cache_brief;
    error_log /var/log/nginx/conda_error.log error;

    proxy_ignore_headers "Set-Cookie";
    proxy_hide_header "Set-Cookie";

    # Global proxy settings
    proxy_buffering on;
    proxy_buffers 16 32k;
    proxy_buffer_size 32k;
    proxy_busy_buffers_size 64k;
    proxy_max_temp_file_size 2048m;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # SSL settings for upstream
    proxy_ssl_server_name on;
    proxy_ssl_name repo.anaconda.com;

    # Cache settings
    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 updating;
    proxy_cache_background_update on;
    proxy_cache_lock on;
    proxy_cache_lock_timeout 5s;
    proxy_cache_revalidate on;
    proxy_next_upstream error timeout http_500 http_502 http_503 http_504;

    # Add cache status header
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Served-By $hostname always;

    # Main package directory
    location /pkgs/ {
        proxy_cache conda;
        proxy_cache_valid 200 365d;
        proxy_cache_key $request_uri;
        proxy_cache_min_uses 1;

        set $backend "https://repo.anaconda.com";
        proxy_pass $backend;

        proxy_set_header Host "repo.anaconda.com";
        proxy_set_header Connection "";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_intercept_errors on;
        error_page 302 = @handle_redirect;

        gzip on;
        gzip_types application/json application/x-bzip2;
        gzip_proxied any;
        
        # Error handling
        error_page 500 502 503 504 /50x.html;
    }

    # Redirect handler
    location @handle_redirect {
        proxy_cache conda;
        proxy_cache_valid 200 365d;
        set $saved_uri '$uri';
        proxy_cache_key $saved_uri;
        set $saved_redirect_location '$upstream_http_location';
        proxy_pass $saved_redirect_location;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host "repo.anaconda.com";
    }

    # JSON metadata files
    location ~ \.json$ {
        proxy_cache conda;
        proxy_cache_valid 200 1d;
        proxy_cache_key $request_uri;
        
        set $backend "https://repo.anaconda.com";
        proxy_pass $backend;

        proxy_set_header Host "repo.anaconda.com";
        proxy_set_header Connection "";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        gzip on;
        gzip_types application/json;
        gzip_proxied any;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 'healthy\n';
    }

    # Error page
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
